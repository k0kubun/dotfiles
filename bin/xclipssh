#!/bin/bash
set -euo pipefail

# Take an SSH host
if [[ $# != 1 ]]; then
  echo "Usage: $0 SSH_HOST"
  exit 1
fi
ssh_host=$1

# Brute-force $DISPLAY
display=$(ssh "$ssh_host" 'cat /proc/*/environ 2> /dev/null | ruby -e "print STDIN.read.split(%[\0]).grep(/DISPLAY/).uniq.join(%[ ])"')
if [[ -z "$display" ]]; then
  echo "Failed to find DISPLAY"
  exit 1
fi
echo "$display"

# Replicate xclip to pbcopy
while ssh "$ssh_host" "${display} clipnotify -s clipboard"; do
  if content=$(ssh "$ssh_host" "${display} xclip -out -selection clipboard"); then
    printf "%s" "$content" | pbcopy
    echo "=> $content"
  fi
done

# Remove the lock for LocalCommand
if [[ -f /tmp/xclipssh.log ]]; then
  mv /tmp/xclipssh.log /tmp/xclipssh.log.old
fi
